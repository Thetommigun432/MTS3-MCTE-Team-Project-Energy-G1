name: E2E Tests

# IMPORTANT: E2E tests are NOT run on pull_request to:
# 1. Avoid exposing secrets to fork PRs
# 2. Save resources (Docker builds are expensive)
# 3. Prevent flaky test failures from blocking PRs
#
# E2E tests run on push to integration and on a nightly schedule.

on:
  push:
    branches: [integration]
  schedule:
    # Run nightly at 4 AM UTC
    - cron: "0 4 * * *"
  workflow_dispatch:
    # Allow manual trigger for debugging

jobs:
  e2e-test:
    name: Docker E2E Pipeline Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create E2E Environment File
        run: |
          # Generate unique run ID for test isolation
          RUN_ID="ci-$(date +%s)-${GITHUB_RUN_ID}"
          echo "E2E_RUN_ID=$RUN_ID" > .env.e2e
          echo "Generated E2E_RUN_ID: $RUN_ID"

          cat >> .env.e2e << 'EOF'
          # E2E Test Environment - Auto-generated by CI
          # These are NOT secrets - they're test credentials for local Docker stack
          INFLUX_TOKEN=influx-admin-token-2026-secure
          INFLUX_ORG=energy-monitor
          INFLUX_BUCKET_RAW=raw_sensor_data
          INFLUX_BUCKET_PRED=predictions
          INFLUX_MEASUREMENT_PRED=prediction
          INFLUX_URL=http://influxdb:8086
          INFLUX_HOST=http://influxdb:8086
          REDIS_HOST=redis
          REDIS_URL=redis://redis:6379
          ENV=test
          DEBUG=false
          CORS_ORIGINS=http://localhost:3000,http://frontend:80
          # Backend URL for test container
          BACKEND_URL=http://backend:8000
          EOF

      - name: Generate Fixtures
        run: |
          # Generate test data fixtures
          docker run --rm -v "${PWD}:/app" -w /app python:3.12-slim sh -c \
            "pip install pandas pyarrow numpy && python scripts/generate_fixtures.py"

      - name: Start Docker Stack
        run: |
          echo "Starting Docker stack..."
          docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml up -d --build --remove-orphans

      - name: Wait for Services
        run: |
          echo "Waiting for InfluxDB to be healthy..."
          timeout 120s bash -c '
            until docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml ps influxdb 2>/dev/null | grep -q "healthy"; do
              echo "  InfluxDB not ready yet..."
              sleep 5
            done
          ' || {
            echo "ERROR: InfluxDB failed to become healthy"
            docker compose --env-file .env.e2e ps
            docker compose --env-file .env.e2e logs influxdb
            exit 1
          }
          echo "InfluxDB is healthy!"

          echo "Waiting for Backend to be reachable..."
          timeout 60s bash -c '
            until curl -sf http://localhost:8000/live >/dev/null 2>&1; do
              echo "  Backend not ready yet..."
              sleep 3
            done
          ' || {
            echo "ERROR: Backend failed to start"
            docker compose --env-file .env.e2e ps
            docker compose --env-file .env.e2e logs backend
            exit 1
          }
          echo "Backend is reachable!"

          echo ""
          echo "=== Service Status ==="
          docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml ps

          # Give pipeline time to process initial data
          echo ""
          echo "Waiting 20s for pipeline to process initial data..."
          sleep 20

      - name: Run E2E Tests
        run: |
          echo "Running E2E tests..."
          docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml run --rm e2e-tests

      - name: Collect Logs on Failure
        if: failure()
        run: |
          echo ""
          echo "=========================================="
          echo "           E2E TEST FAILURE"
          echo "=========================================="
          echo ""

          echo "=== Service Status ==="
          docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml ps
          echo ""

          echo "=== Producer Logs (last 50 lines) ==="
          docker compose --env-file .env.e2e logs --tail=50 --no-color nilm-producer 2>/dev/null || echo "Producer not available"
          echo ""

          echo "=== Inference Logs (last 50 lines) ==="
          docker compose --env-file .env.e2e logs --tail=50 --no-color nilm-inference 2>/dev/null || echo "Inference not available"
          echo ""

          echo "=== Persister Logs (last 50 lines) ==="
          docker compose --env-file .env.e2e logs --tail=50 --no-color nilm-persister 2>/dev/null || echo "Persister not available"
          echo ""

          echo "=== Backend Logs (last 50 lines) ==="
          docker compose --env-file .env.e2e logs --tail=50 --no-color backend 2>/dev/null || echo "Backend not available"
          echo ""

          echo "=== InfluxDB Logs (last 30 lines) ==="
          docker compose --env-file .env.e2e logs --tail=30 --no-color influxdb 2>/dev/null || echo "InfluxDB not available"
          echo ""

          echo "=== Redis Logs (last 20 lines) ==="
          docker compose --env-file .env.e2e logs --tail=20 --no-color redis 2>/dev/null || echo "Redis not available"
          echo ""

          echo "=========================================="
          echo "       END OF DEBUG INFORMATION"
          echo "=========================================="

      - name: Teardown
        if: always()
        run: |
          echo "Tearing down Docker stack..."
          docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml down -v --remove-orphans || true
