
name: E2E Tests

on:
  pull_request:
    branches: [ main, integration, feat/* ]
  push:
    branches: [ integration ]

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate Fixtures
        run: |
          # Use docker to generate fixtures similar to E2E script
          docker run --rm -v "${PWD}:/app" -w /app python:3.11-slim sh -c "pip install pandas pyarrow numpy && python scripts/generate_fixtures.py"

      - name: Start Stack
        run: docker compose -f compose.yaml -f compose.e2e.yaml up -d --build
        env:
          INFLUX_TOKEN: admin-token
          INFLUX_ORG: energy-monitor
          INFLUX_BUCKET_RAW: raw_sensor_data
          INFLUX_BUCKET_PRED: predictions

      - name: Wait for Services
        run: |
          timeout 60s bash -c 'until docker compose -f compose.yaml -f compose.e2e.yaml ps influxdb | grep "healthy"; do sleep 2; done'
          sleep 10

      - name: Run Backend Integration Tests
        run: docker compose -f compose.yaml -f compose.e2e.yaml run --rm e2e-tests
        env:
          INFLUX_TOKEN: admin-token

      - name: Teardown
        if: always()
        run: docker compose -f compose.yaml -f compose.e2e.yaml down -v
