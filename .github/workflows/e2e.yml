
name: E2E Tests

on:
  pull_request:
    branches: [ main, integration, feat/* ]
  push:
    branches: [ integration ]

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create E2E Environment File
        run: |
          cat > .env.e2e << 'EOF'
          # E2E Test Environment - Auto-generated by CI
          INFLUX_TOKEN=influx-admin-token-2026-secure
          INFLUX_ORG=energy-monitor
          INFLUX_BUCKET_RAW=raw_sensor_data
          INFLUX_BUCKET_PRED=predictions
          INFLUX_URL=http://influxdb:8086
          INFLUX_HOST=http://influxdb:8086
          REDIS_HOST=redis
          ENV=test
          CORS_ORIGINS=http://localhost:3000,http://frontend:80
          EOF

      - name: Generate Fixtures
        run: |
          # Use docker to generate fixtures similar to E2E script
          docker run --rm -v "${PWD}:/app" -w /app python:3.11-slim sh -c "pip install pandas pyarrow numpy && python scripts/generate_fixtures.py"

      - name: Start Stack
        run: docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml up -d --build

      - name: Wait for Services
        run: |
          timeout 120s bash -c 'until docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml ps influxdb | grep -q "healthy"; do sleep 2; done'
          sleep 10
          # Show service status for debugging
          docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml ps

      - name: Run Backend Integration Tests
        run: docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml run --rm e2e-tests

      - name: Show Logs on Failure
        if: failure()
        run: docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml logs

      - name: Teardown
        if: always()
        run: docker compose --env-file .env.e2e -f compose.yaml -f compose.e2e.yaml down -v
