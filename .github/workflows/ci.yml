name: CI Tests

on:
  pull_request:
    branches: [main, integration, "feat/*"]
    paths:
      - "apps/backend/**"
      - ".github/workflows/ci.yml"
  push:
    branches: [main, integration]
    paths:
      - "apps/backend/**"

jobs:
  backend-tests:
    name: Backend Unit & Component Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: apps/backend/pyproject.toml

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install CPU version of torch specifically (lighter, faster)
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          # Install the package with dev dependencies
          pip install -e .
          # Ensure test dependencies are available
          pip install pytest pytest-asyncio pytest-cov

      - name: Run Unit Tests
        run: |
          pytest tests/unit -v -m unit --tb=short --no-header -q

      - name: Run Component Tests
        run: |
          pytest tests/component -v -m component --tb=short --no-header -q

      - name: Run All Fast Tests (with coverage)
        run: |
          pytest tests/ -v -m "not e2e and not railway" --tb=short --cov=app --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        if: success()
        uses: codecov/codecov-action@v4
        with:
          file: ./apps/backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  frontend-checks:
    name: Frontend Lint & Typecheck
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript check
        run: npm run typecheck || echo "Typecheck not configured"

      - name: Run lint
        run: npm run lint || echo "Lint not configured"

      - name: Build
        run: npm run build
        env:
          # Use placeholder values for build (not secrets)
          VITE_SUPABASE_URL: "https://placeholder.supabase.co"
          VITE_SUPABASE_ANON_KEY: "placeholder-anon-key"
          VITE_BACKEND_URL: "https://placeholder.railway.app"
          VITE_DEMO_MODE: "true"
