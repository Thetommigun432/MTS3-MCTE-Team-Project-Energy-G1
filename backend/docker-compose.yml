version: '3.8'

services:
  # 1. FLASK API: Gestisce le richieste della Dashboard Azure
  backend-api:
    build: .
    container_name: ai_flask_api
    ports:
      - "5000:5000"
    environment:
      - REDIS_HOST=redis
      - INFLUXDB_URL=http://influxdb:8086
    depends_on:
      - redis
      - influxdb
    networks:
      - energy_network

  # 2. CACHE WORKER: Lavoratore unico che processa e mantiene i dati in Redis
  cache-worker:
    build: .
    container_name: cache_worker
    command: python cache_24h/cache_worker.py
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./Client-data:/app/Client-data
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - energy_network

  # 3. REDIS: La cache ultra-veloce per i dati real-time
  redis:
    image: redis:7.2-alpine
    container_name: redis_cache
    ports:
      - "6379:6379"
    networks:
      - energy_network

  # 4. INFLUXDB: Database per lo storico a lungo termine
  influxdb:
    image: influxdb:2.7
    container_name: influx_db
    ports:
      - "8086:8086"
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - energy_network

  # 5. GRAFANA: Per la visualizzazione tecnica dei dati
  grafana:
    image: grafana/grafana:latest
    container_name: grafana_viz
    ports:
      - "3000:3000"
    depends_on:
      - influxdb
    networks:
      - energy_network

networks:
  energy_network:
    driver: bridge

volumes:
  influxdb_data: